@echo off
chcp 65001 >nul
:: ğŸ® PonyTown Windows ä¸€é”®ä¿®å¤è„šæœ¬
:: é€‚ç”¨äºWindowsç³»ç»Ÿçš„PonyTownè‡ªåŠ¨ä¿®å¤å·¥å…·

title PonyTown ä¸€é”®ä¿®å¤å·¥å…·

echo.
echo  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—    â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—
echo  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘
echo  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘
echo  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  
echo  â–ˆâ–ˆâ•‘     â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•‘   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
echo  â•šâ•â•      â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•   â•šâ•â•      â•šâ•â•    â•šâ•â•â•â•â•â•  â•šâ•â•â•â•šâ•â•â• â•šâ•â•  â•šâ•â•â•â•
echo.
echo           ğŸ® Windows ä¸€é”®ä¿®å¤è„šæœ¬ - 6å¹´å‰æ¸¸æˆé‡æ–°å¤æ´»ï¼ğŸ®
echo.
echo ================================
echo  â±ï¸  é¢„è®¡æ—¶é—´: 10-15åˆ†é’Ÿ
echo  ğŸ¯ ç›®æ ‡: å®Œå…¨å¯ç©çš„2Dåƒç´ å¤šäººåœ¨çº¿æ¸¸æˆ  
echo  ğŸ“‹ éœ€æ±‚: Node.js, Git, MongoDB
echo ================================
echo.

:: æ£€æŸ¥å¿…éœ€å·¥å…·
echo ğŸ“‹ æ£€æŸ¥å¿…éœ€å·¥å…·...
where node >nul 2>&1 || (echo âŒ Node.jsæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Node.js && pause && exit)
where git >nul 2>&1 || (echo âŒ Gitæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Git && pause && exit)
where npm >nul 2>&1 || (echo âŒ npmæœªå®‰è£…ï¼Œè¯·å…ˆå®‰è£…Node.js && pause && exit)
echo âœ… å¿…éœ€å·¥å…·æ£€æŸ¥å®Œæˆ

:: åˆ›å»ºå·¥ä½œç›®å½•
set "WORK_DIR=ponytown-windows-%time:~0,2%%time:~3,2%%time:~6,2%"
set "WORK_DIR=%WORK_DIR: =0%"
echo.
echo ğŸ“ åˆ›å»ºå·¥ä½œç›®å½•: %WORK_DIR%
mkdir "%WORK_DIR%" 2>nul
cd "%WORK_DIR%"

:: ä¸‹è½½åŸå§‹é¡¹ç›®
echo.
echo ğŸ“¥ ä¸‹è½½PonyTownåŸå§‹é¡¹ç›® (ä½¿ç”¨ç¨³å®šforkç‰ˆæœ¬)...
git clone https://github.com/Ritori2022/ponyTown.git ponytown
if not exist ponytown (echo âŒ ä¸‹è½½å¤±è´¥ && pause && exit)

cd ponytown
echo âœ… é¡¹ç›®å‡†å¤‡å®Œæˆ

:: ä¸‹è½½ä¿®å¤èµ„æº
echo.
echo ğŸ”§ ä¸‹è½½ä¿®å¤èµ„æº...
git clone https://github.com/Ritori2022/pony-town-reboot.git fixes
copy fixes\canvas-mock.js . >nul
echo âœ… ä¿®å¤èµ„æºå‡†å¤‡å®Œæˆ

:: å®‰è£…ä¾èµ–
echo.
echo ğŸ“¦ å®‰è£…é¡¹ç›®ä¾èµ–...
echo    è¿™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ—¶é—´...
call npm install --legacy-peer-deps --ignore-scripts --silent
echo âœ… ä¾èµ–å®‰è£…å®Œæˆ

:: åº”ç”¨æ ¸å¿ƒä¿®å¤
echo.
echo ğŸ”¨ åº”ç”¨æ ¸å¿ƒä¿®å¤...

:: Canvasä¿®å¤
powershell -Command "(Get-Content 'src\scripts\server\canvasUtilsNode.js') -replace 'require\(\"canvas\"\)', 'require(\"./canvas-mock\")' | Set-Content 'src\scripts\server\canvasUtilsNode.js'"

:: ä¸»åº”ç”¨æ¨¡æ¿ä¿®å¤
powershell -Command "(Get-Content 'src\scripts\components\app\app.js') -replace 'templateUrl: ''app.pug''', 'template: `<div class=\"app\"><div class=\"main-box\"><div class=\"main-content\"><router-outlet></router-outlet></div></div></div>`' | Set-Content 'src\scripts\components\app\app.js'"

:: ç‰ˆæœ¬éªŒè¯ä¿®å¤  
powershell -Command "(Get-Content 'src\scripts\components\services\model.js') -replace 'this\.post\(\"/api1/account\", \{\}, false\)', 'this.post(\"/api1/account\", { version: data_1.version }, false)' | Set-Content 'src\scripts\components\services\model.js'"

:: åˆ›å»ºwebpacké…ç½®
echo const path = require('path'); > webpack.simple.js
echo const webpack = require('webpack'); >> webpack.simple.js
echo module.exports = { >> webpack.simple.js
echo   entry: './src/scripts/client/main.js', >> webpack.simple.js
echo   output: { path: path.resolve(__dirname, 'build-copy/assets'), filename: 'main.js' }, >> webpack.simple.js
echo   plugins: [new webpack.IgnorePlugin({ checkResource: r =^> /\.(pug^|scss)$/.test(r) })], >> webpack.simple.js
echo   mode: 'development' >> webpack.simple.js
echo }; >> webpack.simple.js

:: æ·»åŠ npmè„šæœ¬
powershell -Command "(Get-Content 'package.json') -replace '\"scripts\": \{', '\"scripts\": {\n    \"webpack:simple\": \"webpack --config webpack.simple.js\",' | Set-Content 'package.json'"

echo âœ… æ ¸å¿ƒä¿®å¤å®Œæˆ

:: åˆ›å»ºæµ‹è¯•ç™»å½•é¡µé¢
echo.
echo ğŸ” åˆ›å»ºæµ‹è¯•ç™»å½•é¡µé¢...
(
echo ^<!DOCTYPE html^>
echo ^<html^>^<head^>^<title^>PonyTown Test Login^</title^>^</head^>^<body^>
echo ^<h1^>ğŸ® PonyTown Test Login^</h1^>
echo ^<form action="http://localhost:8090/auth/local" method="post"^>
echo   ^<p^>Account ID: ^<input type="text" name="username" value="68acdc3543a9ff7ce48a3daa" /^>^</p^>
echo   ^<p^>Password: ^<input type="password" name="password" value="test" /^>^</p^>
echo   ^<p^>^<input type="submit" value="ğŸš€ Login & Play!" /^>^</p^>
echo ^</form^>
echo ^<p^>ğŸ¯ ç™»å½•åå³å¯è¿›å…¥2Dåƒç´ æ¸¸æˆä¸–ç•Œï¼^</p^>
echo ^</body^>^</html^>
) > mock-login.html

echo âœ… æµ‹è¯•ç™»å½•é¡µé¢åˆ›å»ºå®Œæˆ

:: æ„å»ºé¡¹ç›®
echo.
echo âš™ï¸ æ„å»ºé¡¹ç›®...
call npm run webpack:simple >nul 2>&1

:: å®Œæˆä¿¡æ¯
echo.
echo ğŸ‰ ä¿®å¤å®Œæˆï¼æ¸¸æˆå·²å¯è¿è¡Œï¼
echo ================================
echo ğŸš€ å¯åŠ¨å‘½ä»¤:
echo    set DEVELOPMENT=true ^&^& node pony-town.js --login --local --game
echo.
echo ğŸŒ è®¿é—®åœ°å€:
echo    http://localhost:8090
echo.
echo ğŸ” æµ‹è¯•ç™»å½•:
echo    http://localhost:8090/mock-login.html
echo.
echo ğŸ® è¿™æ˜¯ä¸€ä¸ª2Dåƒç´ é£æ ¼çš„å¤šäººåœ¨çº¿è§’è‰²æ‰®æ¼”æ¸¸æˆ
echo    åˆ›å»ºä½ çš„å°é©¬è§’è‰²ï¼Œæ¢ç´¢ç¾ä¸½çš„åƒç´ ä¸–ç•Œï¼
echo.
echo â­ æˆå°±: 6å¹´å‰çš„é¡¹ç›®é‡æ–°å¤æ´»ï¼
echo ================================
echo.

:: è¯¢é—®æ˜¯å¦å¯åŠ¨
set /p choice="ğŸš€ ç«‹å³å¯åŠ¨æ¸¸æˆ? (y/n): "
if /i "%choice%"=="y" (
    echo.
    echo ğŸ® æ­£åœ¨å¯åŠ¨PonyTownæ¸¸æˆæœåŠ¡å™¨...
    echo ğŸ“± åœ¨æµè§ˆå™¨ä¸­è®¿é—® http://localhost:8090  
    echo ğŸ¯ ä½¿ç”¨ http://localhost:8090/mock-login.html å¿«é€Ÿç™»å½•
    echo.
    echo ğŸ”¥ æ¸¸æˆå¯åŠ¨ä¸­... æŒ‰Ctrl+Cåœæ­¢æœåŠ¡å™¨
    echo.
    set DEVELOPMENT=true
    node pony-town.js --login --local --game
) else (
    echo.
    echo âœ… ä¿®å¤å®Œæˆï¼éšæ—¶å¯ä»¥å¯åŠ¨æ¸¸æˆï¼
    echo ğŸ’¡ æç¤º: è¿›å…¥ %WORK_DIR%\ponytown ç›®å½•è¿è¡Œå¯åŠ¨å‘½ä»¤
    echo.
    pause
)